<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gmail-like Email Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
:root {
  --primary: #4f46e5;
  --accent: #10b981;
  --text-main: #f3f4f6;
  --text-secondary: #cbd5e1;
  --text-muted: #94a3b8;
  --sidebar-bg: #1f2937;
  --main-bg: #111827;
  --border: #374151;
  --shadow: 0 4px 20px rgba(0,0,0,0.3);
  --hover-bg: #272f3b;
  --selected-bg: #374151;
}
html, body {height:100%; margin:0; padding:0; font-family:'Share Tech Mono', monospace; background:var(--main-bg); color:var(--text-main);}
body {display:flex; flex-direction:column; overflow:hidden;}

.navbar {
  height:60px; background:var(--sidebar-bg); display:flex; align-items:center; padding:0 24px;
  font-size:1.2em; font-weight:600; color:var(--primary); justify-content:space-between; box-shadow:var(--shadow);
}
.navbar .logo {display:flex; align-items:center; gap:12px;}
.navbar .logo i {font-size:1.5em;}

.container {flex:1; display:flex; overflow:hidden;}
#sidebar {
  width:300px; background:var(--sidebar-bg); border-right:1px solid var(--border); display:flex; flex-direction:column;
  transition: width 0.3s ease;
}
#sidebar.collapsed {width:80px;}
.sidebar-header {padding:20px; font-weight:700; color:var(--primary); display:flex; justify-content:space-between; align-items:center;}
#email-list {flex:1; overflow-y:auto; padding:10px;}
.email-item {
  background:var(--sidebar-bg); border:none; width:100%; text-align:left; padding:16px; margin-bottom:6px;
  border-radius:8px; cursor:pointer; transition:all 0.2s; display:flex; flex-direction:column;
}
.email-item:hover {background:var(--hover-bg); transform:translateX(3px);}
.email-item.selected {background:var(--selected-bg); border-left:4px solid var(--accent);}
.subject {font-weight:600; color:var(--primary);}
.from {color:var(--text-secondary); font-size:0.95em;}
.date {color:var(--text-muted); font-size:0.85em; margin-top:2px;}
.preview {color:var(--text-muted); font-size:0.9em; margin-top:4px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;}

#main {
  flex:1; padding:32px; overflow-y:auto; background:var(--main-bg);
  display:flex; flex-direction:column; gap:20px;
}
#main h2 {color:var(--primary);}
pre.email-body {
  background:var(--sidebar-bg); padding:20px; border-radius:12px; border:1px solid var(--border);
  font-size:1.1em; white-space:pre-wrap;
}
.predict-btn {
  background:var(--accent); color:#111827; border:none; padding:12px 28px; font-weight:600;
  border-radius:25px; cursor:pointer; transition:all 0.3s; align-self:flex-start;
}
.predict-btn:hover {background:#22c55e; color:#fff; transform:translateY(-2px);}

#ask-ai-panel {
  margin-top:20px; padding:20px; border-radius:12px; background:var(--hover-bg);
  display:flex; flex-direction:column; gap:12px; box-shadow:var(--shadow);
}
#ask-ai-panel input {
  width:100%; padding:10px 14px; border-radius:8px; border:1px solid var(--border); background:#111827; color:var(--text-main);
}
#ask-ai-panel button {
  padding:10px 16px; border-radius:8px; border:none; background:var(--accent); color:#111827; font-weight:600; cursor:pointer;
  transition:all 0.3s;
}
#ask-ai-panel button:hover {background:#22c55e; color:#fff;}
#ask-ai-response {
  background:#1f2937; padding:12px; border-radius:8px; font-size:0.95em; white-space:pre-wrap; color:var(--text-main);
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
</head>
<body>
<div class="navbar">
  <div class="logo"><i class="fas fa-envelope"></i> <span>Inbox</span></div>
  <div>skyrim-data-quest</div>
</div>

<div class="container">
  <div id="sidebar">
    <div class="sidebar-header">
      Inbox
      <i class="fas fa-chevron-left" onclick="toggleSidebar()" style="cursor:pointer;"></i>
    </div>
    <div id="email-list"></div>
  </div>

  <div id="main">
    <h2>Welcome!</h2>
    <p style="color:var(--text-secondary);">Select an email to view details. Your AI assistant can analyze phishing risk and content.</p>
  </div>
</div>

<script>
const API_URL = 'http://localhost:3000/ask-ai';
let sidebarCollapsed = false;

function toggleSidebar() {
  const sb = document.getElementById('sidebar');
  sidebarCollapsed = !sidebarCollapsed;
  sb.classList.toggle('collapsed', sidebarCollapsed);
}

function parseSender(from) {
  if(!from) return {name:'', email:''};
  const match = from.match(/^(.*?)(?:\s*<(.+?)>)?$/);
  return {name: match?.[1]?.replace(/"/g,'').trim()||'', email:match?.[2]?.trim()||''};
}

// CHANGED: fetch from saved_emails instead of parsed_emails
async function fetchEmailList() {
  const resp = await fetch('/parsed_emails/');
  const text = await resp.text();
  return Array.from(text.matchAll(/href="([^"]+\.json)"/g)).map(m=>m[1]);
}

async function loadEmailList(selectedFile) {
  const files = await fetchEmailList();
  const listDiv = document.getElementById('email-list');
  listDiv.innerHTML = '';
  if(!files.length){
    listDiv.innerHTML='<div style="color:#94a3b8;text-align:center;margin-top:40px;">No emails found</div>';
    return;
  }

  for(const file of files.reverse()){
    try {
      // CHANGED: fetch from saved_emails instead of parsed_emails
      const resp = await fetch('/parsed_emails/'+file);
      if(!resp.ok) continue;
      const parsed = await resp.json();
      const email = parsed.email||{};
      const sender=parseSender(email.from);
      const div=document.createElement('button');
      div.className='email-item';
      div.innerHTML = `
        <div class="subject">${email.subject || 'No Subject'}</div>
        <div class="from">${sender.name||sender.email||'Unknown sender'}</div>
        <div class="date">${email.date||''}</div>
        <div class="preview">${(email.body||'').slice(0,60)}${email.body?.length>60?'...':''}</div>
      `;
      div.onclick = () => { window.location.hash=encodeURIComponent(file); showEmail(file, div); };
      listDiv.appendChild(div);
      if(selectedFile && file===selectedFile) showEmail(file, div);
    } catch(e) { console.error(e); }
  }
}

async function showEmail(filename, div) {
  document.querySelectorAll('.email-item').forEach(d=>d.classList.remove('selected'));
  if(div) div.classList.add('selected');

  try {
    // CHANGED: fetch from saved_emails instead of parsed_emails
    const resp = await fetch('/parsed_emails/'+filename);
    if(!resp.ok) throw new Error();
    const parsed = await resp.json();
    const email = parsed.email||{};
    const sender = parseSender(email.from);

    document.getElementById('main').innerHTML = `
      <h2>${email.subject||'(No Subject)'}</h2>
      <div class="from"><b>From:</b> ${sender.name?' '+sender.name:''}${sender.email?' <'+sender.email+'>' : ''}</div>
      <div class="date"><b>Date:</b> ${email.date||''}</div>
      <pre class="email-body">${email.body||''}</pre>
      <button class="predict-btn" id="predict-btn">Predict</button>
      <div id="ask-ai-panel">
        <input type="text" id="ask-ai-question" placeholder="Ask AI about this email..."/>
        <button id="ask-ai-btn">Ask AI</button>
        <div id="ask-ai-response">AI response will appear here.</div>
      </div>
    `;

    document.getElementById('predict-btn').onclick = () => {
      window.location.href = `predict_view.html?file=${encodeURIComponent(filename)}`;
    };

    document.getElementById('ask-ai-btn').onclick = async () => {
      const question = document.getElementById('ask-ai-question').value.trim();
      if(!question) return;
      const respDiv = document.getElementById('ask-ai-response');
      respDiv.textContent = "Fetching AI response...";
      try {
        const response = await fetch(API_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({emailSubject: email.subject||'', emailBody: email.body||'', question})
        });
        const data = await response.json();
        respDiv.textContent = data.answer || "❌ Failed to get AI response";
      } catch(err) { respDiv.textContent = "❌ Failed to get AI response: "+err.message; }
    };

    anime({targets:'#main', opacity:[0,1], translateY:[20,0], duration:500, easing:'easeOutExpo'});

  } catch(e) {
    console.error(e);
    document.getElementById('main').innerHTML='<p style="color:#f87171;">Failed to load email</p>';
  }
}

function init(){
  const selectedFile = decodeURIComponent(window.location.hash.replace(/^#/,'') || null);
  loadEmailList(selectedFile);
}
window.addEventListener('hashchange', init);
init();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gmail-like Email Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
:root {
  --primary: #4f46e5;
  --accent: #10b981;
  --text-main: #f3f4f6;
  --text-secondary: #cbd5e1;
  --text-muted: #94a3b8;
  --sidebar-bg: #1f2937;
  --main-bg: #111827;
  --border: #374151;
  --shadow: 0 4px 20px rgba(0,0,0,0.3);
  --hover-bg: #272f3b;
  --selected-bg: #374151;
}
html, body {height:100%; margin:0; padding:0; font-family:'Share Tech Mono', monospace; background:var(--main-bg); color:var(--text-main);}
body {display:flex; flex-direction:column; overflow:hidden;}

.navbar {
  height:60px; background:var(--sidebar-bg); display:flex; align-items:center; padding:0 24px;
  font-size:1.2em; font-weight:600; color:var(--primary); justify-content:space-between; box-shadow:var(--shadow);
}
.navbar .logo {display:flex; align-items:center; gap:12px;}
.navbar .logo i {font-size:1.5em;}
.navbar .chatbot-btn {
  background: var(--accent); color: #111827; border: none; padding: 8px 16px;
  border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s;
}
.navbar .chatbot-btn:hover {background: #22c55e; color: #fff; transform: translateY(-2px);}

.container {flex:1; display:flex; overflow:hidden;}
#sidebar {
  width:300px; background:var(--sidebar-bg); border-right:1px solid var(--border); display:flex; flex-direction:column;
  transition: width 0.3s ease;
}
#sidebar.collapsed {width:80px;}
.sidebar-header {padding:20px; font-weight:700; color:var(--primary); display:flex; justify-content:space-between; align-items:center;}
#email-list {flex:1; overflow-y:auto; padding:10px;}
.email-item {
  background:var(--sidebar-bg); border:none; width:100%; text-align:left; padding:16px; margin-bottom:6px;
  border-radius:8px; cursor:pointer; transition:all 0.2s; display:flex; flex-direction:column;
}
.email-item:hover {background:var(--hover-bg); transform:translateX(3px);}
.email-item.selected {background:var(--selected-bg); border-left:4px solid var(--accent);}
.subject {font-weight:600; color:var(--primary);}
.from {color:var(--text-secondary); font-size:0.95em;}
.date {color:var(--text-muted); font-size:0.85em; margin-top:2px;}
.preview {color:var(--text-muted); font-size:0.9em; margin-top:4px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;}

#main {
  flex:1; padding:32px; overflow-y:auto; background:var(--main-bg);
  display:flex; flex-direction:column; gap:20px;
}
#main h2 {color:var(--primary);}
pre.email-body {
  background:var(--sidebar-bg); padding:20px; border-radius:12px; border:1px solid var(--border);
  font-size:1.1em; white-space:pre-wrap;
}
.predict-btn {
  background:var(--accent); color:#111827; border:none; padding:12px 28px; font-weight:600;
  border-radius:25px; cursor:pointer; transition:all 0.3s; align-self:flex-start;
}
.predict-btn:hover {background:#22c55e; color:#fff; transform:translateY(-2px);}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
</head>
<body>
<div class="navbar">
  <div class="logo"><i class="fas fa-envelope"></i> <span>Inbox</span></div>
  <button class="chatbot-btn" onclick="openChatbot()">Chatbot</button>
</div>

<div class="container">
  <div id="sidebar">
    <div class="sidebar-header">
      Inbox
      <i class="fas fa-chevron-left" onclick="toggleSidebar()" style="cursor:pointer;"></i>
    </div>
    <div id="email-list"></div>
  </div>

  <div id="main">
    <h2>Welcome!</h2>
    <p style="color:var(--text-secondary);">Select an email to view details. Your AI assistant can analyze phishing risk and content.</p>
  </div>
</div>

<script>
const API_URL = 'http://localhost:3000/ask-ai';
let sidebarCollapsed = false;

function toggleSidebar() {
  const sb = document.getElementById('sidebar');
  sidebarCollapsed = !sidebarCollapsed;
  sb.classList.toggle('collapsed', sidebarCollapsed);
}

function openChatbot() {
  // Open chatbot.html in a new tab
  window.open('chatbot.html', '_blank');
}

function parseSender(from) {
  if(!from) return {name:'', email:''};
  const match = from.match(/^(.*?)(?:\s*<(.+?)>)?$/);
  return {name: match?.[1]?.replace(/"/g,'').trim()||'', email:match?.[2]?.trim()||''};
}

async function fetchEmailList() {
  const resp = await fetch('/parsed_emails/');
  const text = await resp.text();
  return Array.from(text.matchAll(/href="([^"]+\.json)"/g)).map(m=>m[1]);
}

async function loadEmailList(selectedFile) {
  const files = await fetchEmailList();
  const listDiv = document.getElementById('email-list');
  listDiv.innerHTML = '';
  if(!files.length){
    listDiv.innerHTML='<div style="color:#94a3b8;text-align:center;margin-top:40px;">No emails found</div>';
    return;
  }

  for(const file of files.reverse()){
    try {
      const resp = await fetch('/parsed_emails/'+file);
      if(!resp.ok) continue;
      const parsed = await resp.json();
      const email = parsed.email || parsed;
      const sender = parseSender(email.from);

      let senderStr = '';
      if(sender.name && sender.email) senderStr = `${sender.name} <${sender.email}>`;
      else if(sender.name) senderStr = sender.name;
      else if(sender.email) senderStr = sender.email;
      else senderStr = 'Unknown sender';

      const subjectStr = email.subject && email.subject.trim() ? email.subject : 'No Subject';
      const dateStr = email.date ? email.date : '';
      const bodyStr = email.body && email.body.trim() ? email.body : '';

      const div = document.createElement('button');
      div.className = 'email-item';
      div.innerHTML = `
        <div class="subject">${subjectStr}</div>
        <div class="from">${senderStr}</div>
        <div class="date">${dateStr}</div>
        <div class="preview">${bodyStr.slice(0,60)}${bodyStr.length>60?'...':''}</div>
      `;
      div.onclick = () => { window.location.hash=encodeURIComponent(file); showEmail(file, div); };
      listDiv.appendChild(div);
      if(selectedFile && file===selectedFile) showEmail(file, div);
    } catch(e) { console.error(e); }
  }
}

async function showEmail(filename, div) {
  document.querySelectorAll('.email-item').forEach(d=>d.classList.remove('selected'));
  if(div) div.classList.add('selected');

  try {
    const resp = await fetch('/parsed_emails/'+filename);
    if(!resp.ok) throw new Error();
    const parsed = await resp.json();
    const email = parsed.email || parsed;
    const sender = parseSender(email.from);

    let senderStr = '';
    if(sender.name && sender.email) senderStr = `${sender.name} <${sender.email}>`;
    else if(sender.name) senderStr = sender.name;
    else if(sender.email) senderStr = sender.email;
    else senderStr = 'Unknown sender';

    const dateStr = email.date ? email.date : 'Unknown date';
    const subjectStr = email.subject && email.subject.trim() ? email.subject : '(No Subject)';
    let bodyStr = '';
    if (typeof email.body === 'string' && email.body.replace(/[\s\r\n\u200c]+/g, '').length > 0) {
      bodyStr = email.body;
    } else if (typeof email.body === 'string') {
      bodyStr = email.body;
    } else {
      bodyStr = 'No content';
    }

    document.getElementById('main').innerHTML = `
      <h2>${subjectStr}</h2>
      <div class="from"><b>From:</b> ${senderStr}</div>
      <div class="date"><b>Date:</b> ${dateStr}</div>
      <pre class="email-body">${bodyStr}</pre>
      <button class="predict-btn" id="predict-btn">Predict</button>
    `;

    document.getElementById('predict-btn').onclick = () => {
      window.location.href = `predict_view.html?file=${encodeURIComponent(filename)}`;
    };

    anime({targets:'#main', opacity:[0,1], translateY:[20,0], duration:500, easing:'easeOutExpo'});

  } catch(e) {
    console.error(e);
    document.getElementById('main').innerHTML='<p style="color:#f87171;">Failed to load email</p>';
  }
}

function init(){
  const selectedFile = decodeURIComponent(window.location.hash.replace(/^#/,'') || null);
  loadEmailList(selectedFile);
}
window.addEventListener('hashchange', init);
init();
</script>
</body>
</html>
